<?php
/* $Id$ */

/**
 * @file
 * Let users delete their account.
 * 
 * This module will be abandoned when http://drupal.org/node/8 is fixed.
 * 
 * @author
 * Stefan Auditor <stefan.auditor@erdfisch.de>
 */

/**
 * Implementation of hook_perm().
 */
function user_delete_perm() {
  return array('delete own account');
}

/**
 * Implementation of hook_menu().
 */
function user_delete_menu($may_cache) {
  global $user;
  $items = array();

  if (!$may_cache) {
    $items[] = array(
      'path' => 'user/'. arg(1) .'/delete',
      'title' => t('Delete'),
      'callback' => 'user_edit',
      'access' => (user_access('administer users') || (user_access('delete own account') && arg(1) == $user->uid)),
      'type' => MENU_CALLBACK,
    );
  }
  
  return $items;
}

/**
 * Implementation of hook_form_alter().
 */
function user_delete_form_alter($form_id, &$form) {
  global $user;
  
  if($form_id == 'user_edit') {
    //access check
    if(user_access('delete own account') && arg(1) == $user->uid) {
      $form['delete'] = array(
        '#type' => 'submit',
        '#value' => t('Delete'),
        '#weight' => 31,
      );
    }
  }
}

/**
 * Implementation of hook_user().
 */
function user_delete_user($op, &$edit, &$account, $category = NULL) {
  global $user;

  if ($op == 'delete' && $user->uid == 0) {
      //Note: $account->uid is still available!
    drupal_goto(variable_get('site_frontpage', 'node'));
  }
}
